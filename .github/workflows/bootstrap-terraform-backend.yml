name: Bootstrap Terraform Backend

on:
  workflow_dispatch:
    inputs:
      bucket_name:
        description: 'S3 bucket name for Terraform state'
        required: true
        type: string
      dynamodb_table_name:
        description: 'DynamoDB table name for state locking'
        required: true
        type: string
        default: 'terraform-state-locks'
      aws_region:
        description: 'AWS region'
        required: true
        type: string
        default: 'us-east-1'

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::443311183770:role/Github-Actions-Runner-OIDC
          aws-region: ${{ inputs.aws_region }}

      - name: Create S3 Bucket
        run: |
          BUCKET="${{ inputs.bucket_name }}"
          REGION="${{ inputs.aws_region }}"
          
          echo "ğŸª£ Creating S3 bucket: $BUCKET"
          
          # Create bucket (handling us-east-1 special case)
          if [ "$REGION" == "us-east-1" ]; then
            aws s3api create-bucket \
              --bucket "$BUCKET" \
              --region "$REGION"
          else
            aws s3api create-bucket \
              --bucket "$BUCKET" \
              --region "$REGION" \
              --create-bucket-configuration LocationConstraint="$REGION"
          fi
          
          # Enable versioning
          echo "ğŸ“¦ Enabling versioning..."
          aws s3api put-bucket-versioning \
            --bucket "$BUCKET" \
            --versioning-configuration Status=Enabled \
            --region "$REGION"
          
          # Enable encryption
          echo "ğŸ”’ Enabling encryption..."
          aws s3api put-bucket-encryption \
            --bucket "$BUCKET" \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                },
                "BucketKeyEnabled": true
              }]
            }' \
            --region "$REGION"
          
          # Block public access
          echo "ğŸš« Blocking public access..."
          aws s3api put-public-access-block \
            --bucket "$BUCKET" \
            --public-access-block-configuration \
              "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true" \
            --region "$REGION"
          
          echo "âœ… S3 bucket created and configured!"

      - name: Create DynamoDB Table
        run: |
          TABLE="${{ inputs.dynamodb_table_name }}"
          REGION="${{ inputs.aws_region }}"
          
          echo "ğŸ—„ï¸ Creating DynamoDB table: $TABLE"
          
          aws dynamodb create-table \
            --table-name "$TABLE" \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region "$REGION" \
            --tags Key=Purpose,Value=TerraformStateLocking Key=ManagedBy,Value=GitHubActions
          
          echo "âœ… DynamoDB table created!"

      - name: Output Backend Configuration
        run: |
          BUCKET="${{ inputs.bucket_name }}"
          TABLE="${{ inputs.dynamodb_table_name }}"
          REGION="${{ inputs.aws_region }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Terraform Backend Bootstrap Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Add this to your Terraform configuration:"
          echo ""
          echo "terraform {"
          echo "  backend \"s3\" {"
          echo "    bucket         = \"$BUCKET\""
          echo "    key            = \"<your-project>/terraform.tfstate\"  # Change this"
          echo "    region         = \"$REGION\""
          echo "    dynamodb_table = \"$TABLE\""
          echo "    encrypt        = true"
          echo "  }"
          echo "}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ S3 Bucket: $BUCKET"
          echo "ğŸ—„ï¸ DynamoDB Table: $TABLE"
          echo "ğŸŒ Region: $REGION"
          echo ""
          echo "Next steps:"
          echo "1. Copy the backend config above to your Terraform project"
          echo "2. Run: terraform init"
          echo "3. Start deploying your infrastructure!"
